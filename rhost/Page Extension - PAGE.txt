@switch/inline isdbref(u(page))=0,{@tel create(Page Extension <PAGE>)=globalroom()}
&page [u(coi)]=locate(globalroom(),Page Extension <PAGE>,Ti)
@wait 0=@parent u(page)=[u(coi)]
@set u(page)=WIZARD SAFE !NO_COMMAND

&CMD`REPLY u(page)=$^(?s)(?\:r|reply)(?\: +(.+?))?$:@assert/inline words(petr(list,filter(#lambda/isdbref([lit(%0)]),get(%#/LASTPAGEDBY))))=@pemit %#=Nobody's sent you a page.;@assert/inline strlen(%1)=@pemit %#=What will you reply with?;@force/inline/clearregs/localize %#={page %q<list>=%1}
@set u(page)/CMD`REPLY=regexp

&STARTUP u(page)=@command/add reply;@command/alias reply=r;@hook/override/inline reply=u(page),CMD`REPLY;@hook/after page=u(page),FUN`LASTPAGEDBY
&FUN`LASTPAGEDBY u(page)=if(strmatch(after(%u,%b),*=*),if(words(petr(list,iter(filter(#lambda/isdbref([lit(%0)]),namelist(before(after(%u,%b),=))),objid(%i0)))-),if(words(petr(recip,filter(#lambda/and(hasflag([lit(%0)],CONNECTED),or(hasflag(%#,WIZARD),and(elock([lit(%0)]/Page,%#),not(hasflag([lit(%0)],HAVEN))))),%q<list>))),null(iter(%q<recip>,attrib_set(%i0/LASTPAGEDBY,setdiff(setunion(%q<recip>,%#),%i0)))))))