&CMD`+INFO`PENNMUSH [u(cobj,ims)]=$^(?s)(?\:\+)?(info|pinfo|bg)(?\:/(\S+)?)?(?\: +(.+?))?(?\:/(.+?))?(?\:=(.*))?$:@attach %!/CMD`+INFO`MAIN
@set [u(cobj,ims)]/CMD`+INFO`PENNMUSH=regexp
&CMD`+INFO`RHOSTMUSH [u(cobj,ims)]=$^(?s)(?\:\+)?(info|pinfo|bg)(?\:/(\\S+)?)?(?\: +(.+?))?(?\:/(.+?))?(?\:=(.*))?$:@attach %!/CMD`+INFO`MAIN
@set [u(cobj,ims)]/CMD`+INFO`RHOSTMUSH=regexp

&INIT`BG [u(cobj,ims)]=th u(setq`%va,sysname,BG);th u(setq`%va,root,D`BGFILE);th u(setq`%va,private,0);th u(setq`%va,comm,+bg);th u(setq`%va,lockapprove,1)

&INC`SET [u(cobj,ims)]=@attach %!/INC`TARGET;@stop cand(isdbref(pmatch(%0)),not(strlen(%1)))=@attach %!/INC`MSG=ERROR: '%0' matches player [name(%q<target>)]. Use <name>/<filename> format to be more explicit.;@check strlen(%q<filename>)=@attach %!/INC`MSG=ERROR: File name empty.;@check cor(strmatch(%#,%q<target>),u(isadmin`%va,%#))=@attach %!/INC`MSG=ERROR: You may not change another's [u(capnames,%q<sysname>)] files.;@select/inline gt(strlen(u(setr`%va,attr,u(FUN`FINDFILE,%q<target>,%q<root>,%q<filename>))),0)=1,{@select/inline cor(u(getstat,%q<target>,%q<attr>`FLAGS,Locked),cand(%q<lockapprove>,u(approved,%q<target>)))=1,{@check u(isadmin`%va,%#)=@attach %!/INC`MSG=ERROR: That File may not be changed by you.}},0,{@check cor(u(isadmin`%va,%#),cand(strmatch(%#,%q<target>),%q<lockapprove>,not(u(approved,%q<target>))),not(%q<lockapprove>))=@attach %!/INC`MSG=ERROR: Permission denied.;@stop gt(strlen(%q<filename>),28)=@attach %!/INC`MSG=ERROR: File names are limited to 28 characters or less.;@stop u(charsearch,%q<filename>,| / \\ %r %t)=@attach %!/INC`MSG=ERROR: The following characters are not permitted in file names: |, / \\, linebreaks\, and indents.};@check strlen(%2)=@attach %!/INC`MSG=ERROR: Text field empty. To delete a file use %q<comm>/delete.;th u(attrib_set`%va,%q<target>,switch(strlen(%q<attr>),>0,%q<attr>,u(setr`%va,attr2,u(setr`%va,attr,%q<root>`[u(nextslot,%q<target>,%q<root>)]))),%q<filename>);th u(attrib_set`%va,%q<target>,%q<attr>`CONTENTS,%2);th u(setstat,%q<target>,%q<attr>`FLAGS,SetBy,u(objid,%#));th u(setstat,%q<target>,%q<attr>`FLAGS,SetOn,secs());@select/inline %q<target>=%#,{@attach %!/INC`MSG=You set your %q<filename> [u(capnames,%q<sysname>)] File},{@attach %!/INC`MSG=You set %q<t1name>'s [u(capnames,%q<sysname>)] File %q<filename>!;@attach %!/INC`MSG`NOTICE=Your [u(capnames,%q<sysname>)] File %q<filename> was set.,%q<target>}

&INC`RENAME [u(cobj,ims)]=@attach %!/INC`TARGET;@attach %!/INC`FINDFILE=%q<filename>;@select/inline cor(u(getstat,%q<target>,%q<attr>`FLAGS,Locked),cand(%q<lockapprove>,u(approved,%q<target>)))=1,{@check u(isadmin`%va,%#)=@attach %!/INC`MSG=ERROR: That File may not be changed by you.};@check strlen(%2)=@attach %!/INC`MSG=ERROR: New name field empty.;@stop gt(strlen(%2),28)=@attach %!/INC`MSG=ERROR: [u(capnames,%q<sysname>)] names are limited to 18 characters or less.;@stop u(charsearch,%2,| / \\ %r %t)=@attach %!/INC`MSG=ERROR: The following characters are not permitted in [u(capnames,%q<sysname>)] file names: |\, / \\, linebreaks\, and indents.;@stop strlen(u(setr`%va,attr2,u(FUN`FINDFILE,%q<target>,%q<root>,%2)))=@attach %!/INC`MSG=ERROR: An [u(capnames,%q<sysname>)] file already uses that name.;&%q<attr> %q<target>=%2;@select/inline %q<target>=%#,{@attach %!/INC`MSG=File named to '%2'!},{@attach %!/INC`MSG=You renamed %q<t1name>'s %q<foundname> [u(capnames,%q<sysname>)] File to %2;@attach %!/INC`MSG`NOTICE=Your [u(capnames,%q<sysname>)] File %q<foundname> was renamed to %2,%q<target>}